/*! CSS critic - v0.1.0 - 2013-02-23
* http://www.github.com/cburgmer/csscritic
* Copyright (c) 2013 Christoph Burgmer, Copyright (c) 2012 ThoughtWorks, Inc.; Licensed MIT */
window.csscritic=function(e){e.util={},e.util.getDataURIForImage=function(e){var t=window.document.createElement("canvas"),n=t.getContext("2d");return t.width=e.width,t.height=e.height,n.drawImage(e,0,0),t.toDataURL("image/png")},e.util.getImageForUrl=function(e,t,n){var r=new window.Image;r.onload=function(){t(r)},n&&(r.onerror=n),r.src=e},e.util.workAroundTransparencyIssueInFirefox=function(t,n){var r;try{r=e.util.getDataURIForImage(t)}catch(i){n(t);return}e.util.getImageForUrl(r,function(e){n(e)})},e.util.map=function(e,t,n){var r=0,i=[],s;e.length===0&&n(i);var o=function(s){function o(t){r+=1,i[s]=t,r===e.length&&n(i)}t(e[s],o)};for(s=0;s<e.length;s++)o(s)},e.util.queue={};var t=[],n=!1,r=function(){var e;t.length>0?(n=!0,e=t.shift(),e(r)):n=!1};return e.util.queue.execute=function(e){t.push(e),n||r()},e.util.queue.clear=function(){t=[],n=!1},e}(window.csscritic||{}),window.csscritic=function(e,t){e.renderer=e.renderer||{};var n=function(e){var t=!1;return e.forEach(function(e){e.resourceType==="page"&&(t=!0)}),t},r=function(e){var t=[];return e.forEach(function(e){e.url&&t.push(e.url)}),t},i=function(e,i,s,o,u){t.drawURL(e,{cache:!1,width:i,height:s,executeJs:!0,executeJsTimeout:50},function(e,t){var i=t===undefined?[]:r(t);t!==undefined&&n(t)?u():o(e,i)})};return e.renderer.browserRenderer=function(t,n,r,s,o){e.util.queue.execute(function(e){i(t,n,r,function(t,n){s(t,n),e()},function(){o&&o(),e()})})},e.renderer.getImageForPageUrl=e.renderer.browserRenderer,e}(window.csscritic||{},rasterizeHTML),window.csscritic=function(e,t){return e.storage=e.storage||{},e.domstorage={},e.domstorage.storeReferenceImage=function(n,r){var i,s;try{i=e.util.getDataURIForImage(r)}catch(o){throw window.alert("An error occurred reading the canvas. Are you sure you are using Firefox?\n"+o),o}s={referenceImageUri:i},t.setItem(n,JSON.stringify(s))},e.domstorage.readReferenceImage=function(n,r,i){var s=t.getItem(n),o;s?(o=JSON.parse(s),e.util.getImageForUrl(o.referenceImageUri,function(e){r(e)},i)):i()},e.storage.storeReferenceImage=e.domstorage.storeReferenceImage,e.storage.readReferenceImage=e.domstorage.readReferenceImage,e}(window.csscritic||{},localStorage),window.csscritic=function(e,t,n,r,i){var s,o,u=function(){s=[],o=[]};u();var a=function(e,r,i,s,o){var u={status:e,pageUrl:r,pageImage:i};return i&&(u.resizePageImage=function(e,n,i){t.getImageForPageUrl(r,e,n,function(e){u.pageImage=e,i(e)})},u.acceptPage=function(){n.storeReferenceImage(r,u.pageImage)}),s&&(u.referenceImage=s),o&&o.length&&(u.erroneousPageUrls=o),u},f=function(t,n){e.util.map(t,function(t,n){e.util.map(s,function(e,n){e.reportComparisonStarting?e.reportComparisonStarting({pageUrl:t},n):n()},n)},n)},l=function(e,t,n,r,i,o){var u,f,l=0,c=s.length,h=function(){l+=1,l===c&&o()};if(!c){o();return}f=a(e,t,n,r,i);for(u=0;u<c;u++)s[u].reportComparison(f,h)},c=function(t,n){e.util.map(s,function(e,n){e.report?e.report({success:t},n):n()},n)};e.addReporter=function(e){s.push(e)},e.clearReporters=function(){s=[]};var h=function(e,t){t&&i.diff(e,t)},p=function(n,r,s,o,u){t.getImageForPageUrl(n,r,s,function(t,r){var s,a;h(t,o),e.util.workAroundTransparencyIssueInFirefox(t,function(e){o?(s=i.equal(e,o),a=s?"passed":"failed"):a="referenceMissing",l(a,n,t,o,r,function(){u&&u(a)})})},function(){var e="error";l(e,n,null,null,null,function(){u&&u(e)})})};return e.compare=function(e,t){n.readReferenceImage(e,function(n){p(e,n.width,n.height,n,t)},function(){p(e,800,600,null,t)})},e.add=function(e){o.push(e)},e.execute=function(t){f(o,function(){e.util.map(o,function(t,n){e.compare(t,function(e){n(e==="passed")})},function(e){var n=e.indexOf(!1)===-1;c(n,function(){t&&t(n)})})})},e.clear=u,e}(window.csscritic||{},window.csscritic.renderer,window.csscritic.storage,window,imagediff),window.csscritic=function(e,t){e.basicHTMLReporterUtil={},e.basicHTMLReporterUtil.getDifferenceCanvas=function(e,n){var r=imagediff.diff(e,n),i=t.createElement("canvas"),s;return i.height=r.height,i.width=r.width,s=i.getContext("2d"),s.putImageData(r,0,0),i};var n=function(e,t){var n=e.style.width,r=e.style.height;e.onmouseup=function(){if(n!==e.style.width||r!==e.style.height)n=e.style.width,r=e.style.height,t(n,r)}},r=function(){var e="csscritic_basichtmlreporter",n=t.getElementById(e),r;return n===null&&(n=t.createElement("div"),n.id=e,r=t.createElement("div"),r.className="timeTaken",n.appendChild(r),t.getElementsByTagName("body")[0].appendChild(n)),n},i=function(e,r){var i=t.createElement("div"),s=t.createElement("div"),o=t.createElement("div"),u;return s.className="pageImageContainer",s.style.width=e.pageImage.width+"px",s.style.height=e.pageImage.height+"px",r&&(u=t.createElement("span"),u.className="caption",u.textContent="Page",i.appendChild(u)),o.className="innerPageImageContainer",o.appendChild(e.pageImage),s.appendChild(o),n(s,function(){var t=parseInt(s.style.width,10),n=parseInt(s.style.height,10),r=e.pageImage;e.resizePageImage(t,n,function(e){o.removeChild(r),o.appendChild(e)})}),i.className="outerPageImageContainer",i.appendChild(s),i},s=function(e){var n=t.createElement("div"),r=t.createElement("div"),i=t.createElement("span");return r.className="referenceImageContainer",r.appendChild(e.referenceImage),i.className="caption",i.textContent="Reference",n.className="outerReferenceImageContainer",n.appendChild(i),n.appendChild(r),n},o=function(){var e=t.createElement("span");return e.className="finished",e.style.display="none",e},u=function(e){var n=t.createElement("div"),r=t.createElement("button"),i=o();return r.onclick=function(){e.acceptPage(),i.style.display=""},r.textContent="Accept the rendered page",n.className="saveHint warning",n.appendChild(r),n.appendChild(t.createTextNode("and save this as later reference.")),n.appendChild(i),n},a=function(e){var n=t.createElement("div"),r=t.createElement("button"),i=o();return r.onclick=function(){e.acceptPage(),i.style.display=""},r.textContent="accept the rendered page",n.className="updateHint warning",n.appendChild(t.createTextNode("You can")),n.appendChild(r),n.appendChild(t.createTextNode("thus making it the new reference.")),n.appendChild(i),n},f=function(e){var n=t.createElement("div"),r=t.createElement("ul");return n.className="loadErrors warning",n.appendChild(t.createTextNode("Could not load the referenced resources:")),n.appendChild(r),e.erroneousPageUrls.forEach(function(e){var n=t.createElement("li");n.textContent=e,r.appendChild(n)}),n.appendChild(t.createTextNode("Make sure the paths lie within the same origin as this document.")),n},l=function(e){var n=t.createElement("div");return n.className="errorMsg warning",n.textContent="The page '"+e.pageUrl+"' could not be read. Make sure the path lies within the same origin as this document.",n},c=function(n){var r=t.createElement("div");return r.className="differenceCanvasContainer",r.appendChild(e.basicHTMLReporterUtil.getDifferenceCanvas(n.pageImage,n.referenceImage)),r},h=function(e){var n=t.createElement("span");return n.className="status",e.status==="passed"?n.textContent="passed":e.status==="failed"?n.textContent="failed":e.status==="referenceMissing"?n.textContent="missing reference":e.status==="error"&&(n.textContent="error"),n},p=function(e){var n=t.createElement("a");return n.className="pageUrl",n.textContent=e.pageUrl,n.href=e.pageUrl,n},d=function(e){var n=t.getElementById(e);return n||(n=t.createElement("div"),n.id=e,n.style.display="none",n.style.position="absolute",t.getElementsByTagName("body")[0].appendChild(n)),n},v=function(e){while(e.hasChildNodes())e.removeChild(e.lastChild)},m=function(e,t){e.onmouseover=function(e){var n=d("csscritic_basichtmlreporter_tooltip"),r=t.referenceImage;v(n),n.style.display="block",n.style.top=e.pageY+10+"px",n.style.left=e.pageX+10+"px",n.appendChild(r)},e.onmousemove=function(e){var t=d("csscritic_basichtmlreporter_tooltip");t.style.top=e.pageY+10+"px",t.style.left=e.pageX+10+"px"},e.onmouseout=function(){var e=d("csscritic_basichtmlreporter_tooltip");e.style.display="none"}},g=function(e,t){e.className+=" "+t.status,e.appendChild(h(t)),t.erroneousPageUrls&&e.appendChild(f(t)),t.status==="failed"?(e.appendChild(c(t)),e.appendChild(i(t,!0)),e.appendChild(s(t)),e.appendChild(a(t))):t.status==="referenceMissing"?(e.appendChild(u(t)),e.appendChild(i(t))):t.status==="error"?e.appendChild(l(t)):t.status==="passed"&&m(e,t)},y=function(e){var n=t.createElement("div");return n.className="comparison running",n.appendChild(p(e)),n},b=function(e,t){t.className=t.className.replace(" running",""),g(t,e)},w=function(e,t){e+="";while(e.length<t)e="0"+e;return e},E=function(e){var t=Math.floor(e/1e3),n=e%1e3;return t+"."+w(n,3)};return e.BasicHTMLReporter=function(){var e={},t=null;return{reportComparisonStarting:function(n,i){var s=y(n),o=r();t===null&&(t=Date.now()),o.appendChild(s),e[n.pageUrl]=s,i&&i()},reportComparison:function(t,n){var i=e[t.pageUrl];i||(i=y(t),r().appendChild(i)),b(t,i),n&&n()},report:function(){var e=r(),n=t===null?0:Date.now()-t,i=e.getElementsByClassName("timeTaken")[0];i.textContent="finished in "+E(n)+"s"}}},e}(window.csscritic||{},window.document);