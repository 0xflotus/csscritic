/*! CSS critic - v0.1.0 - 2013-04-08
* http://www.github.com/cburgmer/csscritic
* Copyright (c) 2013 Christoph Burgmer, Copyright (c) 2012 ThoughtWorks, Inc.; Licensed MIT */
window.csscritic=function(e){e.util={},e.util.getDataURIForImage=function(e){var t=window.document.createElement("canvas"),n=t.getContext("2d");return t.width=e.width,t.height=e.height,n.drawImage(e,0,0),t.toDataURL("image/png")},e.util.getImageForUrl=function(e,t,n){var r=new window.Image;r.onload=function(){t(r)},n&&(r.onerror=n),r.src=e},e.util.workAroundTransparencyIssueInFirefox=function(t,n){var r;try{r=e.util.getDataURIForImage(t)}catch(i){n(t);return}e.util.getImageForUrl(r,function(e){n(e)})},e.util.map=function(e,t,n){var r=0,i=[],s;e.length===0&&n(i);var o=function(s){function o(t){r+=1,i[s]=t,r===e.length&&n(i)}t(e[s],o)};for(s=0;s<e.length;s++)o(s)},e.util.queue={};var t=[],n=!1,r=function(){var e;t.length>0?(n=!0,e=t.shift(),e(r)):n=!1};return e.util.queue.execute=function(e){t.push(e),n||r()},e.util.queue.clear=function(){t=[],n=!1},e}(window.csscritic||{}),window.csscritic=function(e,t){e.renderer=e.renderer||{};var n=function(e){var t=[];return e.forEach(function(e){e.url&&t.push(e.url)}),t},r=function(e,r,i,s,o){t.drawURL(e,{cache:!1,width:r,height:i,executeJs:!0,executeJsTimeout:50},function(e,t){var r=t===undefined?[]:n(t);e?s(e,r):o()})};return e.renderer.browserRenderer=function(t,n,i,s,o,u){var a=t;s&&(a=s+"/inline?url="+t),e.util.queue.execute(function(e){r(a,n,i,function(t,n){o(t,n),e()},function(){u&&u(),e()})})},e.renderer.getImageForPageUrl=e.renderer.browserRenderer,e}(window.csscritic||{},rasterizeHTML),window.csscritic=function(e,t){return e.storage=e.storage||{},e.domstorage={},e.domstorage.storeReferenceImage=function(n,r){var i,s;try{i=e.util.getDataURIForImage(r)}catch(o){throw window.alert("An error occurred reading the canvas. Are you sure you are using Firefox?\n"+o),o}s={referenceImageUri:i},t.setItem(n,JSON.stringify(s))},e.domstorage.readReferenceImage=function(n,r,i){var s=t.getItem(n),o;s?(o=JSON.parse(s),e.util.getImageForUrl(o.referenceImageUri,function(e){r(e)},i)):i()},e.storage.storeReferenceImage=e.domstorage.storeReferenceImage,e.storage.readReferenceImage=e.domstorage.readReferenceImage,e}(window.csscritic||{},localStorage),window.csscritic=function(e,t,n,r,i){var s,o,u,a=function(){s=[],o=[],u=null};a(),e.setProxy=function(e){u=e};var f=function(e,r,i,s,o){var a={status:e,pageUrl:r,pageImage:i};return i&&(a.resizePageImage=function(e,n,i){t.getImageForPageUrl(r,e,n,u,function(e){a.pageImage=e,i(e)})},a.acceptPage=function(){n.storeReferenceImage(r,a.pageImage)}),s&&(a.referenceImage=s),o&&o.length&&(a.erroneousPageUrls=o),a},l=function(t,n){e.util.map(t,function(t,n){e.util.map(s,function(e,n){e.reportComparisonStarting?e.reportComparisonStarting({pageUrl:t},n):n()},n)},n)},c=function(e,t,n,r,i,o){var u,a,l=0,c=s.length,h=function(){l+=1,l===c&&o()};if(!c){o();return}a=f(e,t,n,r,i);for(u=0;u<c;u++)s[u].reportComparison(a,h)},h=function(t,n){e.util.map(s,function(e,n){e.report?e.report({success:t},n):n()},n)};e.addReporter=function(e){s.push(e)},e.clearReporters=function(){s=[]};var p=function(e,t){t&&i.diff(e,t)},d=function(n,r,s,o,a){t.getImageForPageUrl(n,r,s,u,function(t,r){var s,u;p(t,o),e.util.workAroundTransparencyIssueInFirefox(t,function(e){o?(s=i.equal(e,o),u=s?"passed":"failed"):u="referenceMissing",c(u,n,t,o,r,function(){a&&a(u)})})},function(){var e="error";c(e,n,null,null,null,function(){a&&a(e)})})};return e.compare=function(e,t){n.readReferenceImage(e,function(n){d(e,n.width,n.height,n,t)},function(){d(e,800,600,null,t)})},e.add=function(e){o.push(e)},e.execute=function(t){l(o,function(){e.util.map(o,function(t,n){e.compare(t,function(e){n(e==="passed")})},function(e){var n=e.indexOf(!1)===-1;h(n,function(){t&&t(n)})})})},e.clear=a,e}(window.csscritic||{},window.csscritic.renderer,window.csscritic.storage,window,imagediff),window.csscritic=function(e,t){e.basicHTMLReporterUtil={};var n=function(e){var n=t.createElement("canvas"),r;return n.height=e.height,n.width=e.width,r=n.getContext("2d"),r.putImageData(e,0,0),n};e.basicHTMLReporterUtil.getDifferenceCanvas=function(e,t){var r=imagediff.diff(e,t);return n(r)};var r=function(e){var t=Math.log(256);return Math.floor(255*Math.log(e+1)/t)};e.basicHTMLReporterUtil.getHighlightedDifferenceCanvas=function(e,t){var i=imagediff.diff(e,t);for(var s=0;s<i.data.length;s++)s%4<3&&(i.data[s]=r(i.data[s]));return n(i)};var i=function(e,t){var n=e.style.width,r=e.style.height;e.onmouseup=function(){if(n!==e.style.width||r!==e.style.height)n=e.style.width,r=e.style.height,t(n,r)}},s=function(){var e="csscritic_basichtmlreporter",n=t.getElementById(e),r;return n===null&&(n=t.createElement("div"),n.id=e,r=t.createElement("div"),r.className="timeTaken",n.appendChild(r),t.getElementsByTagName("body")[0].appendChild(n)),n},o=function(e,n){var r=t.createElement("div"),s=t.createElement("div"),o=t.createElement("div"),u;return s.className="pageImageContainer",s.style.width=e.pageImage.width+"px",s.style.height=e.pageImage.height+"px",n&&(u=t.createElement("span"),u.className="caption",u.textContent="Page",r.appendChild(u)),o.className="innerPageImageContainer",o.appendChild(e.pageImage),s.appendChild(o),i(s,function(){var t=parseInt(s.style.width,10),n=parseInt(s.style.height,10),r=e.pageImage;e.resizePageImage(t,n,function(e){o.removeChild(r),o.appendChild(e)})}),r.className="outerPageImageContainer",r.appendChild(s),r},u=function(e){var n=t.createElement("div"),r=t.createElement("div"),i=t.createElement("span");return r.className="referenceImageContainer",r.appendChild(e.referenceImage),i.className="caption",i.textContent="Reference",n.className="outerReferenceImageContainer",n.appendChild(i),n.appendChild(r),n},a=function(){var e=t.createElement("span");return e.className="finished",e.style.display="none",e},f=function(e){var n=t.createElement("div"),r=t.createElement("button"),i=a();return r.onclick=function(){e.acceptPage(),i.style.display=""},r.textContent="Accept the rendered page",n.className="saveHint warning",n.appendChild(r),n.appendChild(t.createTextNode("and save this as later reference.")),n.appendChild(i),n},l=function(e){var n=t.createElement("div"),r=t.createElement("button"),i=a();return r.onclick=function(){e.acceptPage(),i.style.display=""},r.textContent="accept the rendered page",n.className="updateHint warning",n.appendChild(t.createTextNode("You can")),n.appendChild(r),n.appendChild(t.createTextNode("thus making it the new reference.")),n.appendChild(i),n},c=function(e){var n=t.createElement("div"),r=t.createElement("ul");return n.className="loadErrors warning",n.appendChild(t.createTextNode("Could not load the referenced resources:")),n.appendChild(r),e.erroneousPageUrls.forEach(function(e){var n=t.createElement("li");n.textContent=e,r.appendChild(n)}),n.appendChild(t.createTextNode("Make sure the paths lie within the same origin as this document.")),n},h=function(e){var n=t.createElement("div");return n.className="errorMsg warning",n.textContent="The page '"+e.pageUrl+"' could not be rendered. Make sure the path lies within the same origin as this document.",n},p=function(n){var r=t.createElement("div"),i=t.createElement("div"),s=e.basicHTMLReporterUtil.getDifferenceCanvas(n.pageImage,n.referenceImage),o=e.basicHTMLReporterUtil.getHighlightedDifferenceCanvas(n.pageImage,n.referenceImage);return r.className="differenceCanvasContainer",i.className="innerDifferenceCanvasContainer",r.appendChild(i),s.className="differenceCanvas",i.appendChild(s),o.className="highlightedDifferenceCanvas",i.appendChild(o),r},d=function(e){var n=t.createElement("span");return n.className="status",e.status==="passed"?n.textContent="passed":e.status==="failed"?n.textContent="failed":e.status==="referenceMissing"?n.textContent="missing reference":e.status==="error"&&(n.textContent="error"),n},v=function(e){var n=t.createElement("a");return n.className="pageUrl",n.textContent=e.pageUrl,n.href=e.pageUrl,n},m=function(e){var n=t.getElementById(e);return n||(n=t.createElement("div"),n.id=e,n.style.display="none",n.style.position="absolute",t.getElementsByTagName("body")[0].appendChild(n)),n},g=function(e){while(e.hasChildNodes())e.removeChild(e.lastChild)},y=function(e,t){e.onmouseover=function(e){var n=m("csscritic_basichtmlreporter_tooltip"),r=t.referenceImage;g(n),n.style.display="block",n.style.top=e.pageY+10+"px",n.style.left=e.pageX+10+"px",n.appendChild(r)},e.onmousemove=function(e){var t=m("csscritic_basichtmlreporter_tooltip");t.style.top=e.pageY+10+"px",t.style.left=e.pageX+10+"px"},e.onmouseout=function(){var e=m("csscritic_basichtmlreporter_tooltip");e.style.display="none"}},b=function(e,t){e.className+=" "+t.status,e.appendChild(d(t)),t.erroneousPageUrls&&e.appendChild(c(t)),t.status==="failed"?(e.appendChild(p(t)),e.appendChild(o(t,!0)),e.appendChild(u(t)),e.appendChild(l(t))):t.status==="referenceMissing"?(e.appendChild(f(t)),e.appendChild(o(t))):t.status==="error"?e.appendChild(h(t)):t.status==="passed"&&y(e,t)},w=function(e){var n=t.createElement("div");return n.className="comparison running",n.appendChild(v(e)),n},E=function(e,t){t.className=t.className.replace(" running",""),b(t,e)},S=function(e,t){e+="";while(e.length<t)e="0"+e;return e},x=function(e){var t=Math.floor(e/1e3),n=e%1e3;return t+"."+S(n,3)};return e.BasicHTMLReporter=function(){var e={},t=null;return{reportComparisonStarting:function(n,r){var i=w(n),o=s();t===null&&(t=Date.now()),o.appendChild(i),e[n.pageUrl]=i,r&&r()},reportComparison:function(t,n){var r=e[t.pageUrl];r||(r=w(t),s().appendChild(r)),E(t,r),n&&n()},report:function(){var e=s(),n=t===null?0:Date.now()-t,r=e.getElementsByClassName("timeTaken")[0];r.textContent="finished in "+x(n)+"s"}}},e}(window.csscritic||{},window.document);