/*! CSS critic - v0.1.0 - 2012-11-27
* http://www.github.com/cburgmer/csscritic
* Copyright (c) 2012 Christoph Burgmer; Licensed MIT */
/* Integrated dependencies:
 * URI.js (MIT License/GPL v3),
 * cssParser.js (MPL 1.1/GPL 2.0/LGPL 2.1),
 * htmlparser.js,
 * imagediff.js (MIT License),
 * rasterizeHTML.js (MIT License) */
(function(e,t){var n=this;if(typeof module!="undefined"){var r=require("canvas");module.exports=t(n,e,r)}else typeof define=="function"&&typeof define.amd=="object"?define(t):n[e]=t(n,e)})("imagediff",function(e,t,n){function d(e,t){var r=n?new n:document.createElement("canvas");return e&&(r.width=e),t&&(r.height=t),r}function v(e,t){return f.width=e,f.height=t,l.clearRect(0,0,e,t),l.createImageData(e,t)}function m(e){return E(e,o)}function g(e){return E(e,i)}function y(e){return E(e,s)}function b(e){return!!e&&!!E(e,u)&&typeof e.width!==a&&typeof e.height!==a&&typeof e.data!==a}function w(e){return m(e)||g(e)||y(e)||b(e)}function E(e,t){return typeof e=="object"&&!!Object.prototype.toString.apply(e).match(t)}function S(e){var t=e.height,n=e.width,r=e.data,i,s,o;f.width=n,f.height=t,i=l.getImageData(0,0,n,t),s=i.data;for(o=e.data.length;o--;)s[o]=r[o];return i}function x(e){if(m(e))return T(e);if(g(e))return N(e);if(y(e))return C(e);if(b(e))return e}function T(e){var t=e.height,n=e.width;return f.width=n,f.height=t,l.clearRect(0,0,n,t),l.drawImage(e,0,0),l.getImageData(0,0,n,t)}function N(e){var t=e.height,n=e.width,r=e.getContext("2d");return r.getImageData(0,0,n,t)}function C(e){var t=e.canvas,n=t.height,r=t.width;return e.getImageData(0,0,r,n)}function k(e){var t=x(e),n=d(t.width,t.height),r=n.getContext("2d");return r.putImageData(t,0,0),n}function L(e,t){return e.width===t.width}function A(e,t){return e.height===t.height}function O(e,t){return A(e,t)&&L(e,t)}function M(e,t,n){var r=e.data,i=t.data,s=r.length,o;n=n||0;if(!O(e,t))return!1;for(o=s;o--;)if(r[o]!==i[o]&&Math.abs(r[o]-i[o])>n)return!1;return!0}function _(e,t){return(O(e,t)?D:P)(e,t)}function D(e,t){var n=e.height,r=e.width,i=v(r,n),s=e.data,o=t.data,u=i.data,a=u.length,f,l,c,h,p,d;for(c=0;c<a;c+=4)u[c]=Math.abs(s[c]-o[c]),u[c+1]=Math.abs(s[c+1]-o[c+1]),u[c+2]=Math.abs(s[c+2]-o[c+2]),u[c+3]=Math.abs(255-s[c+3]-o[c+3]);return i}function P(e,t){function g(e){a=Math.floor((n-e.height)/2),f=Math.floor((r-e.width)/2)}var n=Math.max(e.height,t.height),r=Math.max(e.width,t.width),i=v(r,n),s=e.data,o=t.data,u=i.data,a,f,l,c,h,p,d,m;for(h=u.length-1;h>0;h-=4)u[h]=255;g(e);for(l=e.height;l--;)for(c=e.width;c--;)h=4*((l+a)*r+(c+f)),p=4*(l*e.width+c),u[h+0]=s[p+0],u[h+1]=s[p+1],u[h+2]=s[p+2];g(t);for(l=t.height;l--;)for(c=t.width;c--;)h=4*((l+a)*r+(c+f)),p=4*(l*t.width+c),u[h+0]=Math.abs(u[h+0]-o[p+0]),u[h+1]=Math.abs(u[h+1]-o[p+1]),u[h+2]=Math.abs(u[h+2]-o[p+2]);return i}function H(){var e;for(e=0;e<arguments.length;e++)if(!w(arguments[e]))throw{name:"ImageTypeError",message:"Submitted object was not an image."}}function B(e,t){return e=document.createElement(e),e&&t&&(e.innerHTML=t),e}function j(e,t,n){var r=k(e),i,s;n=n||Function,i=r.toDataURL().replace(/^data:image\/\w+;base64,/,""),s=new Buffer(i,"base64"),require("fs").writeFile(t,s,n)}var r=/\[object Array\]/i,i=/\[object (Canvas|HTMLCanvasElement)\]/i,s=/\[object CanvasRenderingContext2D\]/i,o=/\[object (Image|HTMLImageElement)\]/i,u=/\[object ImageData\]/i,a="undefined",f=d(),l=f.getContext("2d"),c=e[t],h,p;return p={toBeImageData:function(){return h.isImageData(this.actual)},toImageDiffEqual:function(e,t){return typeof document!==a&&(this.message=function(){var t=B("div"),n=B("div","<div>Actual:</div>"),r=B("div","<div>Expected:</div>"),i=B("div","<div>Diff:</div>"),s=h.diff(this.actual,e),o=d(),u;return o.height=s.height,o.width=s.width,u=o.getContext("2d"),u.putImageData(s,0,0),n.appendChild(k(this.actual)),r.appendChild(k(e)),i.appendChild(o),t.appendChild(n),t.appendChild(r),t.appendChild(i),[t,"Expected not to be equal."]}),h.equal(this.actual,e,t)}},h={createCanvas:d,createImageData:v,isImage:m,isCanvas:g,isContext:y,isImageData:b,isImageType:w,toImageData:function(e){return H(e),b(e)?S(e):x(e)},equal:function(e,t,n){return H(e,t),e=x(e),t=x(t),M(e,t,n)},diff:function(e,t){return H(e,t),e=x(e),t=x(t),_(e,t)},jasmine:p,noConflict:function(){return e[t]=c,h}},typeof module!="undefined"&&(h.imageDataToPNG=j),h}),window.csscritic=function(e,t){e.renderer=e.renderer||{};var n=function(e){var t=!1;return e.forEach(function(e){e.resourceType==="page"&&(t=!0)}),t},r=function(e){var t=[];return e.forEach(function(e){e.url&&t.push(e.url)}),t};return e.renderer.browserRenderer=function(e,i,s,o,u){t.drawURL(e,{cache:!1,width:i,height:s},function(e,t){var i=t===undefined?[]:r(t);t!==undefined&&n(t)?u&&u():o(e,i)})},e.renderer.getImageForPageUrl=e.renderer.browserRenderer,e}(window.csscritic||{},rasterizeHTML),window.csscritic=function(e){return e.storage=e.storage||{},e.domstorage={},e.domstorage.storeReferenceImage=function(t,n){var r,i;try{r=e.util.getDataURIForImage(n)}catch(s){throw window.alert("An error occurred reading the canvas. Are you sure you are using Firefox?\n"+s),s}i={referenceImageUri:r},localStorage.setItem(t,JSON.stringify(i))},e.domstorage.readReferenceImage=function(t,n,r){var i=localStorage.getItem(t),s;i?(s=JSON.parse(i),e.util.getImageForUrl(s.referenceImageUri,function(e){n(e)},r)):r()},e.storage.storeReferenceImage=e.domstorage.storeReferenceImage,e.storage.readReferenceImage=e.domstorage.readReferenceImage,e}(window.csscritic||{}),window.csscritic=function(e,t,n,r,i){var s=[];e.util={},e.util.getDataURIForImage=function(e){var t=r.document.createElement("canvas"),n=t.getContext("2d");return t.width=e.width,t.height=e.height,n.drawImage(e,0,0),t.toDataURL("image/png")},e.util.getImageForUrl=function(e,t,n){var i=new r.Image;i.onload=function(){t(i)},n&&(i.onerror=n),i.src=e},e.util.workAroundTransparencyIssueInFirefox=function(t,n){var r;try{r=e.util.getDataURIForImage(t)}catch(i){n(t);return}e.util.getImageForUrl(r,function(e){n(e)})};var o=function(e,r,i,s,o){var u={status:e,pageUrl:r,pageImage:i};return i&&(u.resizePageImage=function(e,n,i){t.getImageForPageUrl(r,e,n,function(e){u.pageImage=e,i(e)})},u.acceptPage=function(){n.storeReferenceImage(r,u.pageImage)}),s&&(u.referenceImage=s),o&&o.length&&(u.erroneousPageUrls=o),u},u=function(e,t,n,r,i){var u,a;if(!s.length)return;a=o(e,t,n,r,i);for(u=0;u<s.length;u++)s[u].reportComparison(a)};e.addReporter=function(e){s.push(e)},e.clearReporters=function(){s=[]};var a=function(e,t){t&&i.diff(e,t)},f=function(n,r,s,o,f){t.getImageForPageUrl(n,r,s,function(t,r){var s,l;a(t,o),e.util.workAroundTransparencyIssueInFirefox(t,function(e){o?(s=i.equal(e,o),l=s?"passed":"failed"):l="referenceMissing",u(l,n,t,o,r),f&&f(l)})},function(){var e="error";u(e,n,null),f&&f(e)})};return e.compare=function(e,t){n.readReferenceImage(e,function(n){f(e,n.width,n.height,n,t)},function(){f(e,800,600,null,t)})},e}(window.csscritic||{},window.csscritic.renderer,window.csscritic.storage,window,imagediff),window.csscritic=function(e,t){e.basicHTMLReporterUtil={},e.basicHTMLReporterUtil.getDifferenceCanvas=function(e,n){var r=imagediff.diff(e,n),i=t.createElement("canvas"),s;return i.height=r.height,i.width=r.width,s=i.getContext("2d"),s.putImageData(r,0,0),i};var n=function(e,t){var n=e.style.width,r=e.style.height;e.onmouseup=function(){if(n!==e.style.width||r!==e.style.height)n=e.style.width,r=e.style.height,t(n,r)}},r=function(){var e="csscritic_basichtmlreporter",n=t.getElementById(e);return n===null&&(n=t.createElement("div"),n.id=e,t.getElementsByTagName("body")[0].appendChild(n)),n},i=function(e,r){var i=t.createElement("div"),s=t.createElement("div"),o=t.createElement("div"),u;return s.className="pageImageContainer",s.style.width=e.pageImage.width+"px",s.style.height=e.pageImage.height+"px",r&&(u=t.createElement("span"),u.className="caption",u.textContent="Page",i.appendChild(u)),o.className="innerPageImageContainer",o.appendChild(e.pageImage),s.appendChild(o),n(s,function(){var t=parseInt(s.style.width,10),n=parseInt(s.style.height,10),r=e.pageImage;e.resizePageImage(t,n,function(e){o.removeChild(r),o.appendChild(e)})}),i.className="outerPageImageContainer",i.appendChild(s),i},s=function(e){var n=t.createElement("div"),r=t.createElement("div"),i=t.createElement("span");return r.className="referenceImageContainer",r.appendChild(e.referenceImage),i.className="caption",i.textContent="Reference",n.className="outerReferenceImageContainer",n.appendChild(i),n.appendChild(r),n},o=function(){var e=t.createElement("span");return e.className="finished",e.style.display="none",e},u=function(e){var n=t.createElement("div"),r=t.createElement("button"),i=o();return r.onclick=function(){e.acceptPage(),i.style.display=""},r.textContent="Accept the rendered page",n.className="saveHint warning",n.appendChild(r),n.appendChild(t.createTextNode("and save this as later reference.")),n.appendChild(i),n},a=function(e){var n=t.createElement("div"),r=t.createElement("button"),i=o();return r.onclick=function(){e.acceptPage(),i.style.display=""},r.textContent="accept the rendered page",n.className="updateHint warning",n.appendChild(t.createTextNode("You can")),n.appendChild(r),n.appendChild(t.createTextNode("thus making it the new reference.")),n.appendChild(i),n},f=function(e){var n=t.createElement("div"),r=t.createElement("ul");return n.className="loadErrors warning",n.appendChild(t.createTextNode("Could not load the referenced resources:")),n.appendChild(r),e.erroneousPageUrls.forEach(function(e){var n=t.createElement("li");n.textContent=e,r.appendChild(n)}),n.appendChild(t.createTextNode("Make sure the paths lie within the same origin as this document.")),n},l=function(e){var n=t.createElement("div");return n.className="errorMsg warning",n.textContent="The page '"+e.pageUrl+"' could not be read. Make sure the path lies within the same origin as this document.",n},c=function(n){var r=t.createElement("div");return r.className="differenceCanvasContainer",r.appendChild(e.basicHTMLReporterUtil.getDifferenceCanvas(n.pageImage,n.referenceImage)),r},h=function(e){var n=t.createElement("span");return n.className="status",e.status==="passed"?n.textContent="passed":e.status==="failed"?n.textContent="failed":e.status==="referenceMissing"?n.textContent="missing reference":e.status==="error"&&(n.textContent="error"),n},p=function(e){var n=t.createElement("a");return n.className="pageUrl",n.textContent=e.pageUrl,n.href=e.pageUrl,n},d=function(e){var n=t.getElementById(e);return n||(n=t.createElement("div"),n.id=e,n.style.display="none",n.style.position="absolute",t.getElementsByTagName("body")[0].appendChild(n)),n},v=function(e){while(e.hasChildNodes())e.removeChild(e.lastChild)},m=function(e,t){e.onmouseover=function(e){var n=d("csscritic_basichtmlreporter_tooltip"),r=t.referenceImage;v(n),n.style.display="block",n.style.top=e.pageY+10+"px",n.style.left=e.pageX+10+"px",n.appendChild(r)},e.onmousemove=function(e){var t=d("csscritic_basichtmlreporter_tooltip");t.style.top=e.pageY+10+"px",t.style.left=e.pageX+10+"px"},e.onmouseout=function(){var e=d("csscritic_basichtmlreporter_tooltip");e.style.display="none"}},g=function(e){var n=t.createElement("div");return n.className="comparison "+e.status,n.appendChild(p(e)),n.appendChild(h(e)),e.erroneousPageUrls&&n.appendChild(f(e)),e.status==="failed"?(n.appendChild(c(e)),n.appendChild(i(e,!0)),n.appendChild(s(e)),n.appendChild(a(e))):e.status==="referenceMissing"?(n.appendChild(u(e)),n.appendChild(i(e))):e.status==="error"?n.appendChild(l(e)):e.status==="passed"&&m(n,e),n},y=function(e){var t=g(e),n=r();n.appendChild(t)};return e.BasicHTMLReporter=function(){return{reportComparison:y}},e}(window.csscritic||{},window.document);